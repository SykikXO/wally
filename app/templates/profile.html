{% extends "base.html" %}

{% block content %}
<div style="border-bottom: 1px solid var(--dim); padding-bottom: 2rem; margin-bottom: 2rem;">
    <h1 style="margin-bottom: 0.5rem;">@{{ user.username }}</h1>
    <div style="color: var(--dim); font-size: 0.9rem; margin-bottom: 1rem;">
        <span>Joined: {{ user.created_at.strftime('%Y-%m-%d') if user.created_at else 'N/A' }}</span> &bull;
        <span>Profile Views: {{ user.views }}</span>
    </div>

    {% if is_own_profile %}
    <form action="{{ url_for('auth.logout') }}" method="post" style="display:inline;">
        <button type="submit" class="btn">Logout</button>
    </form>
    {% endif %}
</div>

<h2>{{ user.username }}'s Wallpapers</h2>

<div class="grid" id="wallpaper-grid">
    {% include 'partials/wallpaper_grid_items.html' %}
</div>

{% if has_next %}
<div id="loading-sentinel" style="text-align: center; padding: 2rem; color: var(--dim);">
    Loading more...
</div>
{% endif %}

<div id="pagination-data" data-has-next="{{ 'true' if has_next else 'false' }}" data-current-path="{{ request.path }}"
    style="display: none;"></div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const paginationData = document.getElementById('pagination-data');
        if (!paginationData) return;

        let page = 1;
        let hasNext = paginationData.dataset.hasNext === 'true';
        const currentPath = paginationData.dataset.currentPath;
        let isLoading = false;

        const sentinel = document.getElementById('loading-sentinel');
        const grid = document.getElementById('wallpaper-grid');

        if (!sentinel) return;

        const observer = new IntersectionObserver((entries) => {
            if (entries[0].isIntersecting && hasNext && !isLoading) {
                loadMore();
            }
        }, { rootMargin: '200px' });

        observer.observe(sentinel);

        async function loadMore() {
            isLoading = true;
            page++;

            try {
                const url = `${currentPath}?page=${page}&load_more=1`;
                const response = await fetch(url);
                if (!response.ok) throw new Error('Network response was not ok');

                const html = await response.text();

                if (html.trim().length === 0) {
                    hasNext = false;
                    sentinel.style.display = 'none';
                    return;
                }

                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;

                if (tempDiv.children.length === 0) {
                    hasNext = false;
                    sentinel.style.display = 'none';
                    return;
                }

                while (tempDiv.firstChild) {
                    grid.appendChild(tempDiv.firstChild);
                }

            } catch (error) {
                console.error('Error loading more wallpapers:', error);
                hasNext = false;
                sentinel.textContent = 'Error loading more items.';
            } finally {
                isLoading = false;
            }
        }
    });
</script>
{% endblock %}
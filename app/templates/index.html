{% extends "base.html" %}

{% block content %}
<h2 style="margin-top: 0;">Latest Uploads</h2>

<div class="grid" id="wallpaper-grid">
    {% include 'partials/wallpaper_grid_items.html' %}
</div>

{% if has_next %}
<div id="loading-sentinel" style="text-align: center; padding: 2rem; color: var(--dim);">
    Loading more...
</div>
{% endif %}

<div id="pagination-data" data-has-next="{{ 'true' if has_next else 'false' }}" data-current-path="{{ request.path }}"
    style="display: none;"></div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const paginationData = document.getElementById('pagination-data');
        if (!paginationData) return;

        let page = 1;
        let hasNext = paginationData.dataset.hasNext === 'true';
        const currentPath = paginationData.dataset.currentPath;
        let isLoading = false;

        const sentinel = document.getElementById('loading-sentinel');
        const grid = document.getElementById('wallpaper-grid');

        if (!sentinel) return;

        const observer = new IntersectionObserver((entries) => {
            if (entries[0].isIntersecting && hasNext && !isLoading) {
                loadMore();
            }
        }, { rootMargin: '200px' });

        observer.observe(sentinel);

        async function loadMore() {
            isLoading = true;
            page++;

            try {
                // Determine if there's an existing query (like search)
                const urlObj = new URL(window.location.href);
                urlObj.searchParams.set('page', page);
                urlObj.searchParams.set('load_more', '1');

                const response = await fetch(urlObj.toString());
                if (!response.ok) throw new Error('Network response was not ok');

                const html = await response.text();

                if (html.trim().length === 0) {
                    hasNext = false;
                    sentinel.style.display = 'none';
                    return;
                }

                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;

                if (tempDiv.children.length === 0) {
                    hasNext = false;
                    sentinel.style.display = 'none';
                    return;
                }

                while (tempDiv.firstChild) {
                    grid.appendChild(tempDiv.firstChild);
                }

            } catch (error) {
                console.error('Error loading more wallpapers:', error);
                hasNext = false;
                sentinel.textContent = 'Error loading more items.';
            } finally {
                isLoading = false;
            }
        }
    });
</script>
{% endblock %}